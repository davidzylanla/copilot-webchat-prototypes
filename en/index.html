<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Eva – Prototype (EN)</title>

  <!-- Bot Framework Web Chat -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    :root{
      --chat-width: 420px;
      --chat-height: 560px;
      --header-height: 52px;
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0,0,0,.18);
      --gap: 18px;

      --brand: #0b3a44;     /* header bar */
      --brand-2: #0b6a7a;   /* launcher */
      --text-on-brand: #ffffff;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#fff;
      color:#111;
    }

    header{
      padding: 26px 28px 12px;
      border-bottom: 1px solid #eee;
    }
    header h1{
      margin:0;
      font-size: 22px;
      font-weight: 650;
    }
    main{
      padding: 22px 28px;
      color:#444;
      max-width: 960px;
    }

    .chat-shell{
      position: fixed;
      right: var(--gap);
      bottom: calc(var(--gap) + env(safe-area-inset-bottom));
      z-index: 9999;
    }

    #chatbot-popup{
      width: var(--chat-width);
      height: var(--chat-height);
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.10);
      display: none;
      margin-bottom: 12px;
    }
    #chatbot-popup.visible{ display:block; }

    #chatbot-header{
      height: var(--header-height);
      background: var(--brand);
      color: var(--text-on-brand);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 10px 0 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .header-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 14px;
      font-weight: 650;
      letter-spacing: .1px;
    }
    .header-title img{
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display:block;
    }

    .header-buttons{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .icon-button{
      appearance:none;
      border:0;
      background:transparent;
      color: var(--text-on-brand);
      cursor:pointer;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .icon-button:hover{ background: rgba(255,255,255,.12); }
    .icon-button:focus{ outline: 3px solid rgba(255,255,255,.35); outline-offset: 2px; }

    /* Small PII banner */
    .pii-banner{
      font-size: 12px;
      line-height: 1.35;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
      color: #333;
    }

    #webchat{
      height: calc(100% - var(--header-height) - 44px); /* header + pii banner */
      background: #fff;
    }

    /* Simple error panel in-widget */
    #chat-error{
      display:none;
      padding: 12px;
      font-size: 13px;
      color: #111;
      background: #fff3f3;
      border-bottom: 1px solid #ffd0d0;
    }
    #chat-error code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
    }

    #open-chat{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--brand-2);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
    }
    #open-chat.hidden{ display:none; }
    #open-chat img{
      width: 30px;
      height: 30px;
      display:block;
    }

    @media (max-width: 768px){
      #chatbot-popup{
        width: calc(100vw - (var(--gap) * 2));
        height: 75vh;
      }
    }
    @media (max-width: 520px){
      .chat-shell{
        right: 10px;
        bottom: calc(10px + env(safe-area-inset-bottom));
      }
      #chatbot-popup{
        width: calc(100vw - 20px);
        height: 80vh;
      }
    }
  </style>

  <script>
    // ------------------------------------------------------------
    // CONFIG
    // ------------------------------------------------------------
    const evaIconUrl =
      "https://tcs-akamai-stage.tradecommissioner.gc.ca/etc.clientlibs/tcs/clientlibs/clientlib-site/resources/assets/chatbot/chatbot.png";

    // Prefer passing tokenEndpoint via querystring to avoid committing it:
    //   ?tokenEndpoint=https%3A%2F%2F...%2Fdirectline%2Ftoken%3Fapi-version%3D...
    // Fallback placeholder for local testing.
    const TOKEN_ENDPOINT_PLACEHOLDER = "https://bd8b80b56a19e41ba78d4fa1f1c4cd.f3.environment.api.powerplatform.com/powervirtualagents/botsbyschema/crd8f_gacAgentUc02/directline/token?api-version=2022-03-01-preview";

    function getTokenEndpointFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const te = params.get("tokenEndpoint");
      return te && te.trim() ? te.trim() : null;
    }

    function resolveTokenEndpoint() {
      const fromQuery = getTokenEndpointFromQuery();
      if (fromQuery) return fromQuery;
      return TOKEN_ENDPOINT_PLACEHOLDER;
    }

    // WebChat styling (keep it minimal; you can expand later)
    const styleOptions = {
      accent: "#0078D4",
      backgroundColor: "#ffffff",
      botAvatarImage: evaIconUrl,
      botAvatarInitials: "E",
      userAvatarInitials: "U",
      bubbleBackground: "#f5f6f8",
      bubbleFromUserBackground: "#ebefff",
      bubbleTextColor: "#242424",
      bubbleFromUserTextColor: "#242424",
      suggestedActionBackgroundColor: "#0b6a7a",
      suggestedActionTextColor: "#ffffff",
      sendBoxBackground: "#ffffff",
      sendBoxTextColor: "#2e2d2d",
      sendBoxButtonColor: "#0b6a7a",
      sendBoxBorderTop: "solid 1px #e5e7eb",
      hideUploadButton: false
    };

    // ------------------------------------------------------------
    // STATE
    // ------------------------------------------------------------
    let directLineUrl = null;
    let isInitialized = false;
    const STORAGE_KEY_OPEN = "eva_chat_open_v1";

    // ------------------------------------------------------------
    // UI HELPERS
    // ------------------------------------------------------------
    function showChat() {
      document.getElementById("chatbot-popup").classList.add("visible");
      document.getElementById("open-chat").classList.add("hidden");
      sessionStorage.setItem(STORAGE_KEY_OPEN, "1");

      // Lazy init on first open
      if (!isInitialized) {
        initializeChat().catch(() => {/* errors surfaced in widget */});
      }
    }

    function hideChat() {
      document.getElementById("chatbot-popup").classList.remove("visible");
      document.getElementById("open-chat").classList.remove("hidden");
      sessionStorage.setItem(STORAGE_KEY_OPEN, "0");
    }

    function setError(message, details) {
      const el = document.getElementById("chat-error");
      el.style.display = "block";
      el.innerHTML =
        `<strong>Chat could not start.</strong><div style="margin-top:6px">${escapeHtml(message)}</div>` +
        (details ? `<div style="margin-top:8px"><code>${escapeHtml(details)}</code></div>` : "");
    }

    function clearError() {
      const el = document.getElementById("chat-error");
      el.style.display = "none";
      el.innerHTML = "";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[s]));
    }

    // ------------------------------------------------------------
    // BOT/WEBCHAT LOGIC
    // ------------------------------------------------------------
    function createCustomStore() {
      return window.WebChat.createStore(
        {},
        ({ dispatch }) => (next) => (action) => {
          if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
            // Language lock + start event
            dispatch({
              type: "DIRECT_LINE/POST_ACTIVITY",
              meta: { method: "keyboard" },
              payload: {
                activity: {
                  type: "event",
                  name: "startConversation",
                  channelData: {
                    postBack: true,
                    language: "en"   // <— language lock for this EN page
                  }
                }
              }
            });
          }
          return next(action);
        }
      );
    }

    function getRegionalChannelSettingsURL(tokenEndpointUrl) {
      const idx = tokenEndpointUrl.indexOf("/powervirtualagents");
      if (idx < 0) throw new Error("tokenEndpoint must contain '/powervirtualagents'.");

      const environmentEndPoint = tokenEndpointUrl.slice(0, idx);

      const apiIndex = tokenEndpointUrl.indexOf("api-version");
      if (apiIndex < 0) throw new Error("tokenEndpoint must include 'api-version=' querystring.");

      const apiVersion = tokenEndpointUrl.slice(apiIndex).split("=")[1];

      return `${environmentEndPoint}/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`;
    }

    async function getConversationToken(tokenEndpoint) {
      const res = await fetch(tokenEndpoint, { cache: "no-store" });
      const info = await res.json();
      if (!info || !info.token) throw new Error("Token endpoint did not return a token.");
      return info.token;
    }

    async function restartConversation() {
      try {
        clearError();
        const tokenEndpoint = resolveTokenEndpoint();

        if (!directLineUrl) throw new Error("DirectLine URL not initialized yet.");
        if (!tokenEndpoint || tokenEndpoint.includes("{{TOKEN_ENDPOINT_URL}}")) {
          throw new Error("tokenEndpoint is not set. Provide ?tokenEndpoint=... or replace the placeholder.");
        }

        const token = await getConversationToken(tokenEndpoint);

        const newDirectLine = window.WebChat.createDirectLine({
          domain: `${directLineUrl}v3/directline`,
          token
        });

        window.WebChat.renderWebChat(
          { directLine: newDirectLine, styleOptions, store: createCustomStore() },
          document.getElementById("webchat")
        );
      } catch (e) {
        console.error("Restart failed:", e);
        setError("Please set a valid token endpoint, then try again.", e?.message || String(e));
      }
    }

    async function initializeChat() {
      try {
        clearError();
        const tokenEndpoint = resolveTokenEndpoint();

        if (!tokenEndpoint || tokenEndpoint.includes("{{TOKEN_ENDPOINT_URL}}")) {
          throw new Error("tokenEndpoint is not set. Provide ?tokenEndpoint=... or replace the placeholder.");
        }

        const regionalURL = getRegionalChannelSettingsURL(tokenEndpoint);

        const settingsRes = await fetch(regionalURL, { cache: "no-store" });
        const settings = await settingsRes.json();

        directLineUrl = settings?.channelUrlsById?.directline;
        if (!directLineUrl) throw new Error("Could not resolve Direct Line regional URL.");

        const token = await getConversationToken(tokenEndpoint);

        const directLine = window.WebChat.createDirectLine({
          domain: `${directLineUrl}v3/directline`,
          token
        });

        window.WebChat.renderWebChat(
          { directLine, styleOptions, store: createCustomStore() },
          document.getElementById("webchat")
        );

        isInitialized = true;
      } catch (e) {
        console.error("Initialize failed:", e);
        setError("Chat initialization failed.", e?.message || String(e));
      }
    }

    // ------------------------------------------------------------
    // BOOTSTRAP
    // ------------------------------------------------------------
    window.addEventListener("DOMContentLoaded", () => {
      // Set icons
      document.getElementById("evaIcon").src = evaIconUrl;
      document.getElementById("evaLauncherIcon").src = evaIconUrl;

      // Restore open/closed state for this tab session
      const wasOpen = sessionStorage.getItem(STORAGE_KEY_OPEN) === "1";
      if (wasOpen) {
        showChat();
      }

      // ESC closes when open
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          const visible = document.getElementById("chatbot-popup").classList.contains("visible");
          if (visible) hideChat();
        }
      });
    });
  </script>
</head>

<body>
  <header>
    <h1>Trade Commissioner Service</h1>
  </header>

  <main>
    <p>English prototype page. Use the chat launcher in the bottom-right.</p>
  </main>

  <div class="chat-shell" aria-live="polite">
    <div id="chatbot-popup" role="dialog" aria-label="Chat with Eva">
      <div id="chatbot-header">
        <div class="header-title">
          <img id="evaIcon" alt="" />
          <span>Chat with Eva</span>
        </div>
        <div class="header-buttons">
          <button class="icon-button" type="button" onclick="restartConversation()" aria-label="Restart conversation">↻</button>
          <button class="icon-button" type="button" onclick="hideChat()" aria-label="Close chat">×</button>
        </div>
      </div>

      <div class="pii-banner">
        Please do not include personal, sensitive, or confidential information in this chat.
      </div>

      <div id="chat-error" role="status" aria-live="polite"></div>
      <div id="webchat" role="main"></div>
    </div>

    <button id="open-chat" type="button" onclick="showChat()" aria-label="Open chat">
      <img id="evaLauncherIcon" alt="" />
    </button>
  </div>
</body>
</html>
