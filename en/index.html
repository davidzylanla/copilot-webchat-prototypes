<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Eva – Prototype (EN)</title>

  <!-- Bot Framework Web Chat -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    :root{
      --chat-width: 420px;
      --chat-height: 560px;
      --header-height: 52px;
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0,0,0,.18);
      --gap: 18px;

      --brand: #0b3a44;     /* header bar */
      --brand-2: #0b6a7a;   /* launcher */
      --text-on-brand: #ffffff;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#fff;
      color:#111;
    }

    /* Minimal page content */
    header{
      padding: 26px 28px 12px;
      border-bottom: 1px solid #eee;
    }
    header h1{
      margin:0;
      font-size: 22px;
      font-weight: 650;
    }
    main{
      padding: 22px 28px;
      color:#444;
      max-width: 960px;
    }

    /* Floating chat shell */
    .chat-shell{
      position: fixed;
      right: var(--gap);
      bottom: calc(var(--gap) + env(safe-area-inset-bottom));
      z-index: 9999;
    }

    /* Popup window */
    #chatbot-popup{
      width: var(--chat-width);
      height: var(--chat-height);
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.10);
      display: none;
      margin-bottom: 12px;
    }
    #chatbot-popup.visible{ display:block; }

    /* Header bar */
    #chatbot-header{
      height: var(--header-height);
      background: var(--brand);
      color: var(--text-on-brand);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 10px 0 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .header-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 14px;
      font-weight: 650;
      letter-spacing: .1px;
    }
    .header-title img{
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display:block;
    }

    .header-buttons{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .icon-button{
      appearance:none;
      border:0;
      background:transparent;
      color: var(--text-on-brand);
      cursor:pointer;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .icon-button:hover{ background: rgba(255,255,255,.12); }
    .icon-button:focus{ outline: 3px solid rgba(255,255,255,.35); outline-offset: 2px; }

    /* Webchat host */
    #webchat{
      height: calc(100% - var(--header-height));
      background: #fff;
    }

    /* Launcher button */
    #open-chat{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--brand-2);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
    }
    #open-chat.hidden{
      display:none;
    }
    #open-chat img{
      width: 30px;
      height: 30px;
      display:block;
    }

    /* Mobile: fullscreen chat */
    @media (max-width: 768px){
      #chatbot-popup{
        width: calc(100vw - (var(--gap) * 2));
        height: 75vh;
      }
    }
    @media (max-width: 520px){
      .chat-shell{
        right: 10px;
        bottom: calc(10px + env(safe-area-inset-bottom));
      }
      #chatbot-popup{
        width: calc(100vw - 20px);
        height: 80vh;
      }
    }
  </style>

  <script>
    // ============================================================
    // REQUIRED: Replace this placeholder with your token endpoint
    // Example shape is something like:
    // https://<env>.api.powerplatform.com/powervirtualagents/bots/<botId>/directline/token?api-version=2022-03-01-preview
    // ============================================================
    const tokenEndpoint = "https://bd8b80b56a19e41ba78d4fa1f1c4cd.f3.environment.api.powerplatform.com/powervirtualagents/botsbyschema/crd8f_gacAgentUc02/directline/token?api-version=2022-03-01-preview";

    // Your icon (also used in header)
    const evaIconUrl = "https://tcs-akamai-stage.tradecommissioner.gc.ca/etc.clientlibs/tcs/clientlibs/clientlib-site/resources/assets/chatbot/chatbot.png";

    // Keep a working styleOptions, but you can trim later
    const styleOptions = {
      accent: "#0078D4",
      backgroundColor: "#ffffff",
      botAvatarImage: evaIconUrl,
      botAvatarInitials: "E",
      userAvatarInitials: "U",
      bubbleBackground: "#f5f6f8",
      bubbleFromUserBackground: "#ebefff",
      bubbleTextColor: "#242424",
      bubbleFromUserTextColor: "#242424",
      suggestedActionBackgroundColor: "#0b6a7a",
      suggestedActionTextColor: "#ffffff",
      sendBoxBackground: "#ffffff",
      sendBoxTextColor: "#2e2d2d",
      sendBoxButtonColor: "#0b6a7a",
      sendBoxBorderTop: "solid 1px #e5e7eb",
      hideUploadButton: false
    };

    let directLineUrl = null;

    function showChat() {
      document.getElementById("chatbot-popup").classList.add("visible");
      document.getElementById("open-chat").classList.add("hidden");
    }
    function hideChat() {
      document.getElementById("chatbot-popup").classList.remove("visible");
      document.getElementById("open-chat").classList.remove("hidden");
    }

    function createCustomStore() {
      return window.WebChat.createStore(
        {},
        ({ dispatch }) => (next) => (action) => {
          if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
            dispatch({
              type: "DIRECT_LINE/POST_ACTIVITY",
              meta: { method: "keyboard" },
              payload: {
                activity: {
                  channelData: { postBack: true },
                  name: "startConversation",
                  type: "event"
                }
              }
            });
          }
          return next(action);
        }
      );
    }

    function getRegionalChannelSettingsURL(tokenEndpointUrl) {
      const idx = tokenEndpointUrl.indexOf("/powervirtualagents");
      if (idx < 0) throw new Error("tokenEndpoint must contain '/powervirtualagents'.");

      const environmentEndPoint = tokenEndpointUrl.slice(0, idx);

      const apiIndex = tokenEndpointUrl.indexOf("api-version");
      if (apiIndex < 0) throw new Error("tokenEndpoint must include 'api-version=' querystring.");

      const apiVersion = tokenEndpointUrl.slice(apiIndex).split("=")[1];

      return `${environmentEndPoint}/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`;
    }

    async function restartConversation() {
      try {
        if (!directLineUrl) {
          console.error("DirectLine URL not initialized.");
          return;
        }

        const res = await fetch(tokenEndpoint);
        const info = await res.json();
        if (!info.token) throw new Error("Failed to get conversation token.");

        const newDirectLine = window.WebChat.createDirectLine({
          domain: `${directLineUrl}v3/directline`,
          token: info.token
        });

        window.WebChat.renderWebChat(
          { directLine: newDirectLine, styleOptions, store: createCustomStore() },
          document.getElementById("webchat")
        );
      } catch (e) {
        console.error("Failed to restart conversation:", e);
      }
    }

    async function initializeChat() {
      try {
        if (!tokenEndpoint || tokenEndpoint.includes("{{TOKEN_ENDPOINT_URL}}") || tokenEndpoint.includes("ENTER ENDPOINT HERE")) {
          console.error("Set tokenEndpoint to a valid URL before testing.");
          return;
        }

        const regionalChannelSettingsURL = getRegionalChannelSettingsURL(tokenEndpoint);

        const settingsRes = await fetch(regionalChannelSettingsURL);
        const settings = await settingsRes.json();

        directLineUrl = settings?.channelUrlsById?.directline;
        if (!directLineUrl) throw new Error("Failed to get DirectLine URL from regional channel settings.");

        const tokenRes = await fetch(tokenEndpoint);
        const info = await tokenRes.json();
        if (!info.token) throw new Error("Failed to get conversation token.");

        const directLine = window.WebChat.createDirectLine({
          domain: `${directLineUrl}v3/directline`,
          token: info.token
        });

        window.WebChat.renderWebChat(
          { directLine, styleOptions, store: createCustomStore() },
          document.getElementById("webchat")
        );
      } catch (e) {
        console.error("Failed to initialize chat:", e);
      }
    }

    // Start immediately (renders into the hidden popup; opens when user clicks)
    window.addEventListener("DOMContentLoaded", () => {
      // set header icon
      const icon = document.getElementById("evaIcon");
      if (icon) icon.src = evaIconUrl;

      const launcherIcon = document.getElementById("evaLauncherIcon");
      if (launcherIcon) launcherIcon.src = evaIconUrl;

      initializeChat();
    });
  </script>
</head>

<body>
  <header>
    <h1>Trade Commissioner Service</h1>
  </header>

  <main>
    <p>This is a minimal prototype page. Use the chat launcher in the bottom-right to open Eva.</p>
  </main>

  <div class="chat-shell" aria-live="polite">
    <div id="chatbot-popup" role="dialog" aria-label="Chat with Eva">
      <div id="chatbot-header">
        <div class="header-title">
          <img id="evaIcon" alt="" />
          <span>Chat with Eva</span>
        </div>
        <div class="header-buttons">
          <button class="icon-button" type="button" onclick="restartConversation()" aria-label="Restart conversation">
            ↻
          </button>
          <button class="icon-button" type="button" onclick="hideChat()" aria-label="Close chat">
            ×
          </button>
        </div>
      </div>
      <div id="webchat" role="main"></div>
    </div>

    <button id="open-chat" type="button" onclick="showChat()" aria-label="Open chat">
      <img id="evaLauncherIcon" alt="" />
    </button>
  </div>
</body>
</html>
